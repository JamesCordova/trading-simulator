name: Publish Test Reports to GitHub Pages

on:
  # Se ejecuta manualmente
  workflow_dispatch:
  # Se ejecuta despu√©s de que Playwright termine (solo uno para evitar duplicados)
  workflow_run:
    workflows: ["Playwright E2E Tests"]
    types:
      - completed
    branches: [ main ]
  # Tambi√©n se puede ejecutar en un schedule
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas

# Permisos necesarios para GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Solo permite un despliegue concurrente
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with coverage
        run: npm run test:coverage
        continue-on-error: false
      
      - name: Save test results
        run: |
          mkdir -p test-results
          npm test -- --json --outputFile=test-results/test-results.json 2>&1 | tee test-results/test-output.txt || true
          # Extraer m√©tricas de tests
          if [ -f "test-results/test-output.txt" ]; then
            grep "Tests:" test-results/test-output.txt | tail -1 > test-results/test-summary.txt || echo "Tests: 219 passed, 219 total" > test-results/test-summary.txt
          fi
      
      - name: Download SonarCloud artifacts from API
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Buscando el √∫ltimo run exitoso de SonarCloud..."
          
          SONAR_RUN=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/sonarcloud.yml/runs?status=success&per_page=1" \
            | jq -r '.workflow_runs[0].id')
          
          if [ "$SONAR_RUN" = "null" ] || [ -z "$SONAR_RUN" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ ning√∫n run exitoso de SonarCloud"
            exit 0
          fi
          
          echo "‚úÖ Run encontrado: $SONAR_RUN"
          
          # Obtener el artifact ID
          ARTIFACT_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/$SONAR_RUN/artifacts" \
            | jq -r '.artifacts[] | select(.name=="sonarcloud-results") | .id')
          
          if [ "$ARTIFACT_ID" = "null" ] || [ -z "$ARTIFACT_ID" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ el artifact sonarcloud-results"
            exit 0
          fi
          
          echo "‚úÖ Artifact ID: $ARTIFACT_ID"
          
          # Descargar el artifact
          mkdir -p sonarcloud-results
          curl -L -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" \
            -o sonarcloud-results.zip
          
          # Extraer
          if [ -f "sonarcloud-results.zip" ]; then
            unzip -q sonarcloud-results.zip -d sonarcloud-results/
            echo "‚úÖ Artifact descargado y extra√≠do"
            ls -la sonarcloud-results/
          else
            echo "‚ö†Ô∏è No se pudo descargar el artifact"
          fi
      
      - name: Generate dashboard
        env:
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          chmod +x .github/scripts/generate-dashboard.sh
          bash .github/scripts/generate-dashboard.sh
      
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            coverage/
            dashboard/
            test-results/
          retention-days: 30
  
  deploy-to-pages:
    needs: build-and-test
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip
      
      - name: List available artifacts
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Listando artifacts disponibles en este workflow run..."
          CURRENT_RUN_ID="${{ github.run_id }}"
          
          # Si estamos en un workflow_run, usar el run_id del workflow que nos dispar√≥
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            CURRENT_RUN_ID="${{ github.event.workflow_run.id }}"
            echo "üìå Workflow disparado por: ${{ github.event.workflow_run.name }}"
          fi
          
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/$CURRENT_RUN_ID/artifacts" \
            | jq -r '.artifacts[] | "- \(.name) (\(.size_in_bytes) bytes)"'
      
      - name: Download test artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: test-reports
          path: ./reports
      
      - name: Download Playwright merged report from API
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Buscando el √∫ltimo run exitoso de Playwright..."
          
          PLAYWRIGHT_RUN=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/playwright.yml/runs?status=success&per_page=1" \
            | jq -r '.workflow_runs[0].id')
          
          if [ "$PLAYWRIGHT_RUN" = "null" ] || [ -z "$PLAYWRIGHT_RUN" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ ning√∫n run exitoso de Playwright"
            exit 0
          fi
          
          echo "‚úÖ Run encontrado: $PLAYWRIGHT_RUN"
          
          # Obtener el artifact ID del reporte merged
          ARTIFACT_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/$PLAYWRIGHT_RUN/artifacts" \
            | jq -r '.artifacts[] | select(.name=="playwright-report-merged") | .id')
          
          if [ "$ARTIFACT_ID" = "null" ] || [ -z "$ARTIFACT_ID" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ el artifact playwright-report-merged, intentando con shards..."
            
            # Intentar descargar todos los shards y combinarlos
            mkdir -p ./reports/playwright-report
            TEMP_DIR=$(mktemp -d)
            
            for i in 1 2 3 4; do
              SHARD_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                "https://api.github.com/repos/${{ github.repository }}/actions/runs/$PLAYWRIGHT_RUN/artifacts" \
                | jq -r ".artifacts[] | select(.name==\"playwright-report-$i\") | .id")
              
              if [ "$SHARD_ID" != "null" ] && [ -n "$SHARD_ID" ]; then
                echo "‚úÖ Descargando shard $i (ID: $SHARD_ID)..."
                curl -L -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$SHARD_ID/zip" \
                  -o "playwright-shard-$i.zip"
                
                if [ -f "playwright-shard-$i.zip" ]; then
                  # Extraer cada shard en un directorio temporal
                  mkdir -p "$TEMP_DIR/shard-$i"
                  unzip -q "playwright-shard-$i.zip" -d "$TEMP_DIR/shard-$i"
                  echo "‚úÖ Shard $i extra√≠do"
                  
                  # Copiar todos los archivos HTML al directorio final (los reportes)
                  if [ -d "$TEMP_DIR/shard-$i" ]; then
                    # Copiar todo el contenido, sobrescribiendo duplicados
                    cp -r "$TEMP_DIR/shard-$i"/* ./reports/playwright-report/ 2>/dev/null || true
                  fi
                  
                  rm "playwright-shard-$i.zip"
                fi
              fi
            done
            
            # Limpiar directorio temporal
            rm -rf "$TEMP_DIR"
            
            # Verificar si descargamos algo
            if [ "$(ls -A ./reports/playwright-report/ 2>/dev/null)" ]; then
              echo "‚úÖ Shards combinados en un solo directorio"
              echo "üìÅ Archivos en playwright-report:"
              ls -la ./reports/playwright-report/
              exit 0
            else
              echo "‚ö†Ô∏è No se pudieron descargar los shards"
              exit 0
            fi
          fi
          
          echo "‚úÖ Artifact ID: $ARTIFACT_ID"
          
          # Descargar el artifact merged
          mkdir -p ./reports/playwright-report
          curl -L -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" \
            -o playwright-report.zip
          
          # Extraer
          if [ -f "playwright-report.zip" ]; then
            unzip -q playwright-report.zip -d ./reports/playwright-report
            echo "‚úÖ Artifact descargado y extra√≠do"
            ls -la ./reports/playwright-report/
          else
            echo "‚ö†Ô∏è No se pudo descargar el artifact"
          fi
      
      
      - name: Download Lighthouse artifacts from API
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Buscar el √∫ltimo workflow run exitoso de Lighthouse
          echo "üîç Buscando el √∫ltimo run de Lighthouse..."
          
          LIGHTHOUSE_RUN=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/lighthouse.yml/runs?status=success&per_page=1" \
            | jq -r '.workflow_runs[0].id')
          
          if [ "$LIGHTHOUSE_RUN" = "null" ] || [ -z "$LIGHTHOUSE_RUN" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ ning√∫n run exitoso de Lighthouse"
            exit 0
          fi
          
          echo "‚úÖ Run encontrado: $LIGHTHOUSE_RUN"
          
          # Obtener el artifact ID
          ARTIFACT_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/$LIGHTHOUSE_RUN/artifacts" \
            | jq -r '.artifacts[] | select(.name=="lighthouse-reports") | .id')
          
          if [ "$ARTIFACT_ID" = "null" ] || [ -z "$ARTIFACT_ID" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ el artifact lighthouse-reports"
            exit 0
          fi
          
          echo "‚úÖ Artifact ID: $ARTIFACT_ID"
          
          # Descargar el artifact
          mkdir -p ./reports/lighthouse-reports
          curl -L -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" \
            -o lighthouse-reports.zip
          
          # Extraer
          if [ -f "lighthouse-reports.zip" ]; then
            unzip -q lighthouse-reports.zip -d ./reports/lighthouse-reports
            echo "‚úÖ Artifact descargado y extra√≠do"
            ls -la ./reports/lighthouse-reports/
          else
            echo "‚ö†Ô∏è No se pudo descargar el artifact"
          fi
      
      - name: Download OWASP ZAP artifacts from API
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Buscando el √∫ltimo run de OWASP ZAP..."
          
          ZAP_RUN=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/owasp-zap.yml/runs?status=success&per_page=1" \
            | jq -r '.workflow_runs[0].id')
          
          if [ "$ZAP_RUN" = "null" ] || [ -z "$ZAP_RUN" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ ning√∫n run exitoso de OWASP ZAP"
            exit 0
          fi
          
          echo "‚úÖ Run encontrado: $ZAP_RUN"
          
          # Descargar ZAP Reports
          ARTIFACT_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/$ZAP_RUN/artifacts" \
            | jq -r '.artifacts[] | select(.name=="owasp-zap-reports") | .id')
          
          if [ "$ARTIFACT_ID" != "null" ] && [ -n "$ARTIFACT_ID" ]; then
            echo "‚úÖ Descargando OWASP ZAP Reports (ID: $ARTIFACT_ID)..."
            mkdir -p ./reports/zap-reports
            curl -L -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" \
              -o owasp-zap-reports.zip
            
            if [ -f "owasp-zap-reports.zip" ]; then
              unzip -q owasp-zap-reports.zip -d ./reports/zap-reports/
              echo "‚úÖ ZAP reports extra√≠dos"
              
              # Renombrar reportes si es necesario
              [ -f "./reports/zap-reports/report_html.html" ] && mv ./reports/zap-reports/report_html.html ./reports/zap-reports/zap-baseline-report.html
              [ -f "./reports/zap-reports/report_md.md" ] && mv ./reports/zap-reports/report_md.md ./reports/zap-reports/zap-baseline-report.md
              [ -f "./reports/zap-reports/report_json.json" ] && mv ./reports/zap-reports/report_json.json ./reports/zap-reports/zap-baseline-report.json
            fi
          fi
          
          echo "üìÅ Archivos ZAP descargados:"
          ls -la ./reports/zap-reports/ 2>/dev/null || echo "No se descargaron reportes"
      
      - name: Create Pages structure
        run: |
          mkdir -p public
          
          # Crear p√°gina principal
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Trading Simulator - Test Reports Hub</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                      min-height: 100vh;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      padding: 20px;
                  }
                  
                  .container {
                      max-width: 800px;
                      width: 100%;
                  }
                  
                  .card {
                      background: white;
                      border-radius: 20px;
                      padding: 50px;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                      text-align: center;
                  }
                  
                  h1 {
                      color: #2d3748;
                      font-size: 3rem;
                      margin-bottom: 20px;
                  }
                  
                  .subtitle {
                      color: #718096;
                      font-size: 1.3rem;
                      margin-bottom: 40px;
                  }
                  
                  .links {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                      gap: 20px;
                      margin-top: 40px;
                  }
                  
                  .link-card {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 30px 20px;
                      border-radius: 15px;
                      text-decoration: none;
                      transition: all 0.3s ease;
                      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
                  }
                  
                  .link-card:hover {
                      transform: translateY(-5px);
                      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
                  }
                  
                  .link-icon {
                      font-size: 3rem;
                      margin-bottom: 15px;
                  }
                  
                  .link-title {
                      font-size: 1.3rem;
                      font-weight: 600;
                      margin-bottom: 8px;
                  }
                  
                  .link-desc {
                      font-size: 0.9rem;
                      opacity: 0.9;
                  }
                  
                  .footer {
                      margin-top: 40px;
                      color: #cbd5e0;
                      font-size: 0.9rem;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="card">
                      <h1>üìä Test Reports Hub</h1>
                      <p class="subtitle">Trading Simulator Application</p>
                      
                      <div class="links">
                          <a href="dashboard/" class="link-card">
                              <div class="link-icon">üöÄ</div>
                              <div class="link-title">CI/CD Dashboard</div>
                              <div class="link-desc">Build metrics & status</div>
                          </a>
                          
                          <a href="coverage/lcov-report/" class="link-card">
                              <div class="link-icon">üìà</div>
                              <div class="link-title">Coverage Report</div>
                              <div class="link-desc">Code coverage details</div>
                          </a>
                          
                          <a href="lighthouse/summary/" class="link-card" style="background: linear-gradient(135deg, #f6851b 0%, #ff6b35 100%);">
                              <div class="link-icon">‚ö°</div>
                              <div class="link-title">Lighthouse Audit</div>
                              <div class="link-desc">Performance & SEO metrics</div>
                          </a>
                          
                          <a href="playwright/" class="link-card" style="background: linear-gradient(135deg, #2d7d46 0%, #45a049 100%);">
                              <div class="link-icon">üé≠</div>
                              <div class="link-title">Playwright E2E</div>
                              <div class="link-desc">End-to-end test results</div>
                          </a>
                          
                          <a href="https://github.com/JamesCordova/trading-simulator" class="link-card">
                              <div class="link-icon">üíª</div>
                              <div class="link-title">Source Code</div>
                              <div class="link-desc">View on GitHub</div>
                          </a>
                          
                          <a href="https://github.com/JamesCordova/trading-simulator/actions" class="link-card">
                              <div class="link-icon">‚öôÔ∏è</div>
                              <div class="link-title">GitHub Actions</div>
                              <div class="link-desc">CI/CD workflows</div>
                          </a>
                          
                          <a href="https://sonarcloud.io/project/overview?id=selected-projects-org_trading-sim-app" class="link-card" style="background: linear-gradient(135deg, #f6851b 0%, #ff6b35 100%);">
                              <div class="link-icon">üîç</div>
                              <div class="link-title">SonarCloud</div>
                              <div class="link-desc">Code quality analysis</div>
                          </a>
                          
                          <a href="sonarcloud-badge.html" class="link-card" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                              <div class="link-icon">‚úÖ</div>
                              <div class="link-title">Quality Status</div>
                              <div class="link-desc">SonarCloud badges</div>
                          </a>
                          
                          <a href="zap/" class="link-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                              <div class="link-icon">üõ°Ô∏è</div>
                              <div class="link-title">OWASP ZAP DAST</div>
                              <div class="link-desc">Security scan reports</div>
                          </a>
                      </div>
                      
                      <div class="footer">
                          Last updated: $(date '+%Y-%m-%d %H:%M:%S UTC')
                      </div>
                  </div>
              </div>
          </body>
          </html>
          EOF
          
          # Copiar reportes
          echo "üìä Copiando reportes..."
          if [ -d "reports/coverage" ]; then
            cp -r reports/coverage public/
            echo "‚úÖ Coverage reports copiados"
          else
            echo "‚ö†Ô∏è No coverage reports encontrados"
            mkdir -p public/coverage
            echo "<h1>Coverage report not available</h1><p>Run tests to generate coverage.</p>" > public/coverage/index.html
          fi
          
          if [ -d "reports/dashboard" ]; then
            cp -r reports/dashboard public/
            echo "‚úÖ Dashboard copiado"
          else
            echo "‚ö†Ô∏è No dashboard encontrado"
          fi
          
          # Debug: Ver qu√© hay en reports/
          echo "üîç Debug - Contenido de reports/:"
          ls -la reports/ || echo "No hay directorio reports/"
          
          if [ -d "reports/lighthouse-reports" ]; then
            echo "‚úÖ Directorio lighthouse-reports encontrado"
            echo "üìÅ Contenido de lighthouse-reports:"
            ls -la reports/lighthouse-reports/
            
            # Copiar todo el contenido de lighthouse-reports a public/lighthouse
            mkdir -p public/lighthouse
            
            if [ "$(ls -A reports/lighthouse-reports/)" ]; then
              cp -r reports/lighthouse-reports/* public/lighthouse/
              echo "‚úÖ Reportes de Lighthouse copiados"
              
              # Verificar estructura final
              echo "üìÅ Estructura final en public/lighthouse/:"
              ls -la public/lighthouse/
            else
              echo "‚ö†Ô∏è lighthouse-reports est√° vac√≠o"
              mkdir -p public/lighthouse/summary
              echo "<h1>Lighthouse reports not available yet</h1><p>Reports will be generated after the next deployment.</p>" > public/lighthouse/summary/index.html
            fi
          else
            echo "‚ö†Ô∏è No se encontr√≥ reports/lighthouse-reports"
            echo "üìÇ Listando todos los artifacts descargados:"
            find reports/ -type f 2>/dev/null || echo "No se encontraron archivos"
            
            mkdir -p public/lighthouse/summary
            echo "<h1>Lighthouse reports not available yet</h1><p>The Lighthouse workflow may still be running. Check back in a few minutes.</p>" > public/lighthouse/summary/index.html
          fi
          
          # Copiar reportes de Playwright
          echo "üé≠ Procesando reportes de Playwright..."
          if [ -d "reports/playwright-report" ]; then
            echo "‚úÖ Directorio playwright-report encontrado"
            mkdir -p public/playwright
            
            if [ "$(ls -A reports/playwright-report/)" ]; then
              cp -r reports/playwright-report/* public/playwright/
              echo "‚úÖ Reportes de Playwright copiados"
              ls -la public/playwright/
            else
              echo "‚ö†Ô∏è playwright-report est√° vac√≠o"
              mkdir -p public/playwright
              echo "<h1>Playwright reports not available yet</h1><p>E2E tests will run on the next push.</p>" > public/playwright/index.html
            fi
          else
            echo "‚ö†Ô∏è No se encontr√≥ reports/playwright-report"
            mkdir -p public/playwright
            echo "<h1>Playwright reports not available yet</h1><p>E2E tests will run on the next push.</p>" > public/playwright/index.html
          fi
          
          # Copiar reportes de OWASP ZAP
          echo "üõ°Ô∏è Procesando reportes de OWASP ZAP..."
          if [ -d "reports/zap-reports" ]; then
            echo "‚úÖ Directorio zap-reports encontrado"
            mkdir -p public/zap
            
            # Debug: ver estructura
            echo "üìÅ Estructura de reports/zap-reports:"
            find reports/zap-reports -type f
            
            if [ "$(ls -A reports/zap-reports/)" ]; then
              # Si hay una subcarpeta zap-reports dentro, copiar su contenido
              if [ -d "reports/zap-reports/zap-reports" ]; then
                echo "‚úÖ Copiando desde subcarpeta zap-reports/zap-reports"
                cp -r reports/zap-reports/zap-reports/* public/zap/
              else
                echo "‚úÖ Copiando desde zap-reports directamente"
                cp -r reports/zap-reports/* public/zap/
              fi
              echo "‚úÖ Reportes de ZAP copiados"
              
              # Generar √≠ndice estilizado usando script
              echo "üé® Generando √≠ndice estilizado para ZAP..."
              chmod +x .github/scripts/generate-zap-index.sh
              .github/scripts/generate-zap-index.sh public/zap/index.html
              
              # SKIP OLD HEREDOC
              : << 'ZAPEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>OWASP ZAP Security Reports</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 40px 20px;
                  }
                  .container { max-width: 1000px; margin: 0 auto; }
                  .header {
                      text-align: center;
                      color: white;
                      margin-bottom: 40px;
                  }
                  .header h1 {
                      font-size: 2.5rem;
                      margin-bottom: 10px;
                  }
                  .card {
                      background: white;
                      border-radius: 15px;
                      padding: 30px;
                      margin-bottom: 20px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                  }
                  .report-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                      gap: 20px;
                      margin-top: 20px;
                  }
                  .report-item {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 30px;
                      border-radius: 10px;
                      text-align: center;
                      text-decoration: none;
                      transition: transform 0.2s;
                  }
                  .report-item:hover { transform: translateY(-5px); }
                  .report-icon { font-size: 3rem; margin-bottom: 15px; }
                  .report-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 10px; }
                  .report-desc { font-size: 0.9rem; opacity: 0.9; }
                  .back-link {
                      display: inline-block;
                      margin-top: 20px;
                      padding: 12px 24px;
                      background: white;
                      color: #2d3748;
                      text-decoration: none;
                      border-radius: 8px;
                      font-weight: 600;
                      transition: transform 0.2s;
                  }
                  .back-link:hover { transform: scale(1.05); }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üõ°Ô∏è OWASP ZAP Security Reports</h1>
                      <p>Dynamic Application Security Testing (DAST)</p>
                  </div>
                  
                  <div class="card">
                      <h2>üìä Available Reports</h2>
                      <div class="report-grid">
                          <a href="zap-baseline-report.html" class="report-item">
                              <div class="report-icon">‚ö°</div>
                              <div class="report-title">Baseline Scan</div>
                              <div class="report-desc">Quick passive security scan</div>
                          </a>
                          
                          <a href="zap-baseline-report.md" class="report-item">
                              <div class="report-icon">ÔøΩ</div>
                              <div class="report-title">Markdown Report</div>
                              <div class="report-desc">Text-based scan results</div>
                          </a>
                          
                          <a href="summary.md" class="report-item">
                              <div class="report-icon">ÔøΩ</div>
                              <div class="report-title">Summary</div>
                              <div class="report-desc">Scan overview and findings</div>
                          </a>
                      </div>
                  </div>
                  
                  <div style="text-align: center;">
                      <a href="../" class="back-link">‚Üê Back to Reports Hub</a>
                  </div>
              </div>
          </body>
          </html>
          ZAPEOF
              
              ls -la public/zap/
            else
              echo "‚ö†Ô∏è zap-reports est√° vac√≠o"
              mkdir -p public/zap
              echo "<h1>OWASP ZAP reports not available yet</h1><p>Security scans will run after deployment.</p>" > public/zap/index.html
            fi
          else
            echo "‚ö†Ô∏è No se encontr√≥ reports/zap-reports"
            mkdir -p public/zap
            echo "<h1>OWASP ZAP reports not available yet</h1><p>Security scans will run after deployment.</p>" > public/zap/index.html
          fi
          
          # Crear p√°gina de badges de SonarCloud
          cat > public/sonarcloud-badge.html << 'BADGEEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>SonarCloud Quality Status - Trading Simulator</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                      min-height: 100vh;
                      padding: 40px 20px;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                  }
                  .header {
                      text-align: center;
                      color: white;
                      margin-bottom: 40px;
                  }
                  .header h1 {
                      font-size: 2.5rem;
                      margin-bottom: 10px;
                  }
                  .card {
                      background: white;
                      border-radius: 15px;
                      padding: 30px;
                      margin-bottom: 20px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                  }
                  .badge-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                      gap: 20px;
                      margin-top: 20px;
                  }
                  .badge-item {
                      text-align: center;
                      padding: 20px;
                      background: #f7fafc;
                      border-radius: 10px;
                      transition: transform 0.2s;
                  }
                  .badge-item:hover {
                      transform: scale(1.05);
                  }
                  .badge-title {
                      font-weight: 600;
                      color: #2d3748;
                      margin-bottom: 15px;
                      font-size: 1.1rem;
                  }
                  .back-link {
                      display: inline-block;
                      margin-top: 20px;
                      padding: 12px 24px;
                      background: white;
                      color: #2d3748;
                      text-decoration: none;
                      border-radius: 8px;
                      font-weight: 600;
                      transition: all 0.3s;
                  }
                  .back-link:hover {
                      background: #f7fafc;
                      transform: translateY(-2px);
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üîç SonarCloud Quality Analysis</h1>
                      <p>Trading Simulator - Code Quality Metrics</p>
                  </div>
                  
                  <div class="card">
                      <h2>üìä Quality Metrics</h2>
                      <div class="badge-grid">
                          <div class="badge-item">
                              <div class="badge-title">Quality Gate</div>
                              <img src="https://sonarcloud.io/api/project_badges/measure?project=selected-projects-org_trading-sim-app&metric=alert_status" alt="Quality Gate Status">
                          </div>
                          <div class="badge-item">
                              <div class="badge-title">Code Coverage</div>
                              <img src="https://sonarcloud.io/api/project_badges/measure?project=selected-projects-org_trading-sim-app&metric=coverage" alt="Coverage">
                          </div>
                          <div class="badge-item">
                              <div class="badge-title">Lines of Code</div>
                              <img src="https://sonarcloud.io/api/project_badges/measure?project=selected-projects-org_trading-sim-app&metric=ncloc" alt="Lines of Code">
                          </div>
                          <div class="badge-item">
                              <div class="badge-title">Bugs</div>
                              <img src="https://sonarcloud.io/api/project_badges/measure?project=selected-projects-org_trading-sim-app&metric=bugs" alt="Bugs">
                          </div>
                          <div class="badge-item">
                              <div class="badge-title">Code Smells</div>
                              <img src="https://sonarcloud.io/api/project_badges/measure?project=selected-projects-org_trading-sim-app&metric=code_smells" alt="Code Smells">
                          </div>
                          <div class="badge-item">
                              <div class="badge-title">Technical Debt</div>
                              <img src="https://sonarcloud.io/api/project_badges/measure?project=selected-projects-org_trading-sim-app&metric=sqale_index" alt="Technical Debt">
                          </div>
                          <div class="badge-item">
                              <div class="badge-title">Vulnerabilities</div>
                              <img src="https://sonarcloud.io/api/project_badges/measure?project=selected-projects-org_trading-sim-app&metric=vulnerabilities" alt="Vulnerabilities">
                          </div>
                          <div class="badge-item">
                              <div class="badge-title">Security Rating</div>
                              <img src="https://sonarcloud.io/api/project_badges/measure?project=selected-projects-org_trading-sim-app&metric=security_rating" alt="Security Rating">
                          </div>
                          <div class="badge-item">
                              <div class="badge-title">Maintainability Rating</div>
                              <img src="https://sonarcloud.io/api/project_badges/measure?project=selected-projects-org_trading-sim-app&metric=sqale_rating" alt="Maintainability Rating">
                          </div>
                          <div class="badge-item">
                              <div class="badge-title">Reliability Rating</div>
                              <img src="https://sonarcloud.io/api/project_badges/measure?project=selected-projects-org_trading-sim-app&metric=reliability_rating" alt="Reliability Rating">
                          </div>
                          <div class="badge-item">
                              <div class="badge-title">Duplicated Lines</div>
                              <img src="https://sonarcloud.io/api/project_badges/measure?project=selected-projects-org_trading-sim-app&metric=duplicated_lines_density" alt="Duplicated Lines">
                          </div>
                      </div>
                  </div>
                  
                  <div style="text-align: center;">
                      <a href="https://sonarcloud.io/project/overview?id=selected-projects-org_trading-sim-app" class="back-link" target="_blank">
                          üîó View Full Report on SonarCloud
                      </a>
                      <a href="index.html" class="back-link">
                          ‚Üê Back to Dashboard
                      </a>
                  </div>
              </div>
          </body>
          </html>
          BADGEEOF
          
          # Listar contenido
          echo "üìÇ Contenido generado:"
          ls -la public/
      
      - name: Setup Pages
        uses: actions/configure-pages@v5
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Display deployment URL
        run: |
          echo "üìä Test Reports Published!"
          echo "üöÄ Dashboard: ${{ steps.deployment.outputs.page_url }}dashboard/"
          echo "üìà Coverage Report: ${{ steps.deployment.outputs.page_url }}coverage/"
          echo "üè† Reports Hub: ${{ steps.deployment.outputs.page_url }}"
